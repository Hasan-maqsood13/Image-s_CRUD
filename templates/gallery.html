<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Image CRUD</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<div class="container mt-5">
  <h2 class="text-center">Multiple Image CRUD</h2>
  
  <!-- Upload Form -->
  <form id="uploadForm" method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="mb-3">
      <label class="form-label">Title</label>
      <input type="text" class="form-control" name="title" id="title" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Upload Images</label>
      <input type="file" class="form-control" name="images" id="images" multiple required>
    </div>
    <button type="submit" class="btn btn-primary">Upload</button>
  </form>

  <hr>

  <!-- Bulk Delete Button -->
  <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
    <h4>Gallery</h4>
    <button id="deleteSelectedBtn" class="btn btn-danger btn-sm">Delete Selected</button>
  </div>

  <!-- Image Gallery -->
  <div class="row" id="galleryGrid">
    {% for photo in photos %}
      <div class="col-md-3 mb-3" id="photo-{{ photo.id }}">
        <div class="card">
          <img src="{{ photo.image.url }}" class="card-img-top" style="height:200px; object-fit:cover;">
          <div class="card-body text-center">
            <h6 id="title-{{ photo.id }}">{{ photo.title }}</h6>
            <input type="checkbox" class="select-photo" value="{{ photo.id }}">
            <br>
            <button class="btn btn-sm btn-warning edit-btn" 
                    data-id="{{ photo.id }}" 
                    data-title="{{ photo.title }}">
              Edit
            </button>
            <button class="btn btn-sm btn-danger delete-btn" data-id="{{ photo.id }}">Delete</button>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<script>
$(document).ready(function () {

    // Upload multiple images
    $("#uploadForm").on("submit", function (e) {
        e.preventDefault();
        var formData = new FormData(this);

        $.ajax({
            type: "POST",
            url: "{% url 'gallery' %}",
            data: formData,
            processData: false,
            contentType: false,
            success: function (res) {
                if (res.success) {
                    res.photos.forEach(function(photo) {
                        $("#galleryGrid").prepend(`
                          <div class="col-md-3 mb-3" id="photo-${photo.id}">
                            <div class="card">
                              <img src="${photo.image_url}" class="card-img-top" style="height:200px; object-fit:cover;">
                              <div class="card-body text-center">
                                <h6 id="title-${photo.id}">${photo.title}</h6>
                                <input type="checkbox" class="select-photo" value="${photo.id}">
                                <br>
                                <button class="btn btn-sm btn-warning edit-btn" 
                                        data-id="${photo.id}" 
                                        data-title="${photo.title}">
                                  Edit
                                </button>
                                <button class="btn btn-sm btn-danger delete-btn" data-id="${photo.id}">Delete</button>
                              </div>
                            </div>
                          </div>
                        `);
                    });
                    $("#uploadForm")[0].reset();
                } else {
                    Swal.fire("Error", res.message, "error");
                }
            },
            error: function () {
                Swal.fire("Error", "Error uploading images", "error");
            }
        });
    });

    // Single Delete
    $(document).on("click", ".delete-btn", function () {
        var photoId = $(this).data("id");
        Swal.fire({
            title: "Are you sure?",
            text: "This photo will be deleted!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "Yes, delete it!"
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    type: "POST",
                    url: `/delete/${photoId}/`,
                    data: {
                        csrfmiddlewaretoken: "{{ csrf_token }}"
                    },
                    success: function (res) {
                        if (res.success) {
                            $("#photo-" + photoId).remove();
                            Swal.fire("Deleted!", res.message, "success");
                        } else {
                            Swal.fire("Error!", res.message, "error");
                        }
                    },
                    error: function () {
                        Swal.fire("Error!", "Error deleting photo", "error");
                    }
                });
            }
        });
    });

    // Bulk Delete
    $("#deleteSelectedBtn").on("click", function () {
        var selected = [];
        $(".select-photo:checked").each(function () {
            selected.push($(this).val());
        });

        if (selected.length === 0) {
            Swal.fire("No photos selected", "Please select at least one photo", "warning");
            return;
        }

        Swal.fire({
            title: "Are you sure?",
            text: "Selected photos will be deleted!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "Yes, delete them!"
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    type: "POST",
                    url: "/delete-multiple/",
                    data: {
                        ids: JSON.stringify(selected),
                        csrfmiddlewaretoken: "{{ csrf_token }}"
                    },
                    success: function (res) {
                        if (res.success) {
                            selected.forEach(function (id) {
                                $("#photo-" + id).remove();
                            });
                            Swal.fire("Deleted!", res.message, "success");
                        } else {
                            Swal.fire("Error!", res.message, "error");
                        }
                    },
                    error: function () {
                        Swal.fire("Error!", "Error deleting photos", "error");
                    }
                });
            }
        });
    });

    // Edit Photo Title
    $(document).on("click", ".edit-btn", function () {
        var photoId = $(this).data("id");
        var oldTitle = $(this).data("title");

        Swal.fire({
            title: "Edit Title",
            input: "text",
            inputValue: oldTitle,
            showCancelButton: true,
            confirmButtonText: "Save"
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    type: "POST",
                    url: `/edit/${photoId}/`,
                    data: {
                        title: result.value,
                        csrfmiddlewaretoken: "{{ csrf_token }}"
                    },
                    success: function (res) {
                        if (res.success) {
                            $("#title-" + photoId).text(result.value);
                            $(`.edit-btn[data-id='${photoId}']`).data("title", result.value);
                            Swal.fire("Updated!", res.message, "success");
                        } else {
                            Swal.fire("Error!", res.message, "error");
                        }
                    },
                    error: function () {
                        Swal.fire("Error!", "Error updating photo", "error");
                    }
                });
            }
        });
    });

});
</script>
</body>
</html>
