<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Image CRUD</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<div class="container mt-5">
  <h2 class="text-center">Multiple Image CRUD</h2>
  
  <!-- Upload Form -->
  <form id="uploadForm" method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="mb-3">
      <label class="form-label">Title</label>
      <input type="text" class="form-control" name="title" id="title" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Upload Images</label>
      <input type="file" class="form-control" name="images" id="images" multiple required>
    </div>
    <button type="submit" class="btn btn-primary">Upload</button>
  </form>

  <hr>

  <!-- Image Gallery -->
  <div class="row" id="galleryGrid">
    {% for photo in photos %}
      <div class="col-md-3 mb-3" id="photo-{{ photo.id }}">
        <div class="card">
          <img src="{{ photo.image.url }}" class="card-img-top" style="height:200px; object-fit:cover;">
          <div class="card-body text-center">
            <h6>{{ photo.title }}</h6>
            <button class="btn btn-sm btn-primary edit-btn"
                    data-id="{{ photo.id }}"
                    data-title="{{ photo.title }}">
              Edit
            </button>
            <button class="btn btn-sm btn-primary delete-btn" data-id="{{ photo.id }}">Delete</button>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editForm" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" id="editPhotoId">

          <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" class="form-control" id="editTitle" name="title" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Change Image (optional)</label>
            <input type="file" class="form-control" id="editImage" name="image">
          </div>

          <button type="submit" class="btn btn-success">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
$(document).ready(function () {
    // Upload multiple images
    $("#uploadForm").on("submit", function (e) {
        e.preventDefault();
        var formData = new FormData(this);

        $.ajax({
            type: "POST",
            url: "{% url 'gallery' %}",
            data: formData,
            processData: false,
            contentType: false,
            success: function (res) {
                if (res.success) {
                    res.photos.forEach(function(photo) {
                        $("#galleryGrid").prepend(`
                          <div class="col-md-3 mb-3" id="photo-${photo.id}">
                            <div class="card">
                              <img src="${photo.image_url}" class="card-img-top" style="height:200px; object-fit:cover;">
                              <div class="card-body text-center">
                                <h6>${photo.title}</h6>
                                <button class="btn btn-sm btn-warning edit-btn" 
                                        data-id="${photo.id}" 
                                        data-title="${photo.title}">
                                  Edit
                                </button>
                                <button class="btn btn-sm btn-danger delete-btn" data-id="${photo.id}">Delete</button>
                              </div>
                            </div>
                          </div>
                        `);
                    });
                    $("#uploadForm")[0].reset();
                } else {
                    alert(res.message);
                }
            },
            error: function () {
                alert("Error uploading images");
            }
        });
    });

    // Open Edit Modal
    $(document).on("click", ".edit-btn", function () {
        var photoId = $(this).data("id");
        var title = $(this).data("title");

        $("#editPhotoId").val(photoId);
        $("#editTitle").val(title);

        $("#editModal").modal("show");
    });

    // Submit Edit Form
    $("#editForm").on("submit", function (e) {
        e.preventDefault();

        var photoId = $("#editPhotoId").val();
        var formData = new FormData(this);

        $.ajax({
            type: "POST",
            url: `/edit/${photoId}/`,
            data: formData,
            processData: false,
            contentType: false,
            success: function (res) {
                if (res.success) {
                    $(`#photo-${res.photo.id} h6`).text(res.photo.title);
                    if (res.photo.image_url) {
                        $(`#photo-${res.photo.id} img`).attr("src", res.photo.image_url);
                    }
                    $("#editModal").modal("hide");
                } else {
                    alert(res.message);
                }
            },
            error: function () {
                alert("Error updating photo");
            }
        });
    });

    // Delete photo with confirmation
    $(document).on("click", ".delete-btn", function () {
        var photoId = $(this).data("id");

        Swal.fire({
            title: "Are you sure?",
            text: "This photo will be permanently deleted!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "Yes, delete it!"
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    type: "POST",
                    url: `/delete/${photoId}/`,
                    data: {
                        csrfmiddlewaretoken: "{{ csrf_token }}"
                    },
                    success: function (res) {
                        if (res.success) {
                            $("#photo-" + photoId).remove();
                            Swal.fire("Deleted!", res.message, "success");
                        } else {
                            Swal.fire("Error!", res.message, "error");
                        }
                    },
                    error: function () {
                        Swal.fire("Error!", "Error deleting photo", "error");
                    }
                });
            }
        });
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
